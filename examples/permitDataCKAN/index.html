---
layout: default
published: true
title: Building Permits with BLDS & CKAN
---

<div class="row">
    <div class="col-md-12">

        <!--<div class="btn-group">
            <a href="#" class="btn btn-primary" role="button">View the Example</a>
            <a href="source.html" class="btn btn-default" role="button">Source Code</a>
        </div>-->

        <h2>Overview</h2>
        <p>Many cities publish their building permitting data in near-real time using CKAN with data populated according
            to the BLDS open standard.
            This code example shows how to use the CitySDK to consume this data.</p>

        <p>See the <a href="http://permitdata.org/">BLDS Github Page</a> for more information.</p>

    </div><!-- end col-md-12 -->
</div><!-- end row -->

<div class="row">
    <div class="col-md-12">

        <div class="panel panel-info">
            <div class="panel-heading">
                <h3 class="panel-title">1. Select a City & Dataset</h3>
            </div>
            <div class="panel-body city-and-dataset-step">


                <!-- Nav tabs -->
                <ul class="nav nav-tabs" role="tablist">
                    <li role="presentation" class="active"><a href="#citySelection" aria-controls="citySelection"
                                                              role="tab" data-toggle="tab">Selection</a></li>
                    <li role="presentation"><a href="#citySourceCode" aria-controls="citySourceCode" role="tab"
                                               data-toggle="tab">Get Data Series Lists Code Example</a></li>
                </ul>

                <!-- Tab panes -->
                <div class="tab-content">
                    <div role="tabpanel" class="tab-pane active" id="citySelection">


                        <div class="loading-icon loading-icon-initialstate"></div>

                        <form class="hideWhileLoading">
                            <div class="form-group">
                                <label for="cityDataOrg" class="col-sm-2 control-label">City</label>
                                <select class="form-control" id="cityDataOrg">

                                </select>
                            </div><!-- end form-broup -->
                            <div class="form-group">
                                <label for="cityDataSet" class="col-sm-2 control-label">Permit Data Set</label>
                                <select class="form-control" id="cityDataSet">
                                </select>
                            </div><!-- end form-broup -->
                        </form>


                        <div class="row">
                            <div class="col-md-12 serviceTextDescription">

                            </div>
                        </div><!-- end row -->
                    </div>
                    <div role="tabpanel" class="tab-pane" id="citySourceCode">
<pre>var sdk = new CitySDK();
    var ckan = sdk.modules.ckan;
    ckan.enable();
    ckan.DEFAULT_ENDPOINTS.apiURL = "//www.civicdata.com/api/3/action/";


    var orgList = {};
    var packageList = {};
    var seriesMeta = {};

    <var>ckan</var>.seriesRequest(<var>groupRequest</var>, function (<var>response</var>) {
            var <var>ichi</var> = 0;

            jQuery.each(<var>response</var>.result.packages, function (<var>index</var>, <var>value</var>) {
                if (!(<var>value</var>.organization.id in orgList)) {
                    orgList[<var>value</var>.organization.id] = [];
                    jQuery("#cityDataOrg").append("&lt;option <var>value</var>='" + <var>value</var>.organization.id + "'&gt;" + <var>value</var>.organization.title + "&lt;/option&gt;");
                    if (<var>ichi</var> == 0) {
                        <var>ichi</var> = <var>value</var>.organization.id;
                    }
                }
                orgList[<var>value</var>.organization.id].push(<var>value</var>.resources[0].id);
                packageList[<var>value</var>.resources[0].id] = <var>value</var>;
            });



            selectOrganization(<var>ichi</var>);
            jQuery(".city-and-dataset-step .hideWhileLoading").show();
            jQuery(".city-and-dataset-step .loading-icon-initialstate").hide();

        });


        function selectOrganization(<var>orgID</var>) {

        if (<var>orgID</var> in orgList) {
            jQuery("#cityDataSet").empty();

            jQuery.each(orgList[<var>orgID</var>], function (<var>index</var>, <var>value</var>) {
                jQuery("#cityDataSet").append("&lt;option <var>value</var>='" + <var>value</var> + "'&gt;" + packageList[<var>value</var>]['title'] + "&lt;/option&gt;");
            });


            getSeriesFieldList(jQuery("#cityDataSet").find("option:selected").val(), function (<var>response</var>) {
                setSeriesFieldList(<var>response</var>);
            });

        }
    } // end selectOrganization

    function getSeriesFieldList(<var>seriesID</var>, callback) {

        jQuery(".variables-and-filter-step .hideWhileLoading").hide();
        jQuery(".variables-and-filter-step .loading-icon-initialstate").show();

        jQuery(".serviceTextDescription").empty();
        var <var>serviceTextDescription</var> = "&lt;h4 class='text-primary'&gt;" + packageList[<var>seriesID</var>]['title'] + "&lt;/h4&gt;\
            &lt;p&gt;Last Updated: " + packageList[<var>seriesID</var>]['revision_timestamp'] + "&lt;/p&gt;\
            &lt;p class='text-primary'&gt;" + packageList[<var>seriesID</var>]['notes'] + "&lt;/p&gt;";
        jQuery(".serviceTextDescription").append(<var>serviceTextDescription</var>);


        if (<var>seriesID</var> in seriesMeta) {
            buildRequest();
            callback(seriesMeta[<var>seriesID</var>]);
        } else {
            var <var>request</var> = {
                'resource_id': <var>seriesID</var>,
                'limit': 1
            };

            <var>ckan</var>.APIRequest(<var>request</var>, function (<var>response</var>) {

                seriesMeta[<var>seriesID</var>] = <var>response</var>.result.fields;
                buildRequest();
                callback(seriesMeta[<var>seriesID</var>]);
            });
        }
    }//getSeriesFieldList


    function setSeriesFieldList(<var>response</var>) {
        jQuery("#variables").empty();
        jQuery("#fieldSort").empty();
        jQuery("#fieldSort").append("&lt;option <var>value</var>=\"\"&gt;&lt;/option&gt;");

        jQuery.each(response, function (<var>index</var>, <var>value</var>) {
            jQuery("#variables").append("&lt;option <var>value</var>=\"" + <var>value</var>.id + "\"&gt;" + <var>value</var>.id + "&lt;/option&gt;");
            jQuery("#fieldSort").append("&lt;option <var>value</var>=\"" + <var>value</var>.id + "\"&gt;" + <var>value</var>.id + "&lt;/option&gt;");

        });
        jQuery(".variables-and-filter-step .hideWhileLoading").show();
        jQuery(".variables-and-filter-step .loading-icon-initialstate").hide();
        jQuery("#btnUpdateData").removeAttr("disabled");

    }// set setSeriesFieldList</pre>
                    </div>
                </div>


            </div><!-- end panel-body -->
        </div><!-- end panel panel-info -->


        <div class="panel panel-info">
            <div class="panel-heading">
                <h3 class="panel-title">2. Select Desired Variables & Filter / Where</h3>
            </div>
            <div class="panel-body variables-and-filter-step">

                <div class="loading-icon loading-icon-initialstate"></div>


                <form class="hideWhileLoading">
                    <div class="row">
                        <div class="col-md-6">
                            <h4>Fields / Variables</h4>

                            <label for="variables">Available Variables</label>
                            <p>If no variables are selected, ArcGIS will return ALL of them by default.</p>
                            <select class="form-control" multiple size="15" id="variables"></select>

                        </div><!-- end col-md-6 -->
                        <div class="col-md-6">
                            <h4>Sort By</h4>
                            <p><em>Results can be optionally sorted by field.</em>
                            </p>

                            <select class="form-control" id="fieldSort"></select>


                        </div><!-- end col-md-6 -->

                    </div><!-- end row -->
                </form>
            </div><!-- end panel-body -->
        </div><!-- end panel panel-info -->


        <div class="panel panel-info">
            <div class="panel-heading">
                <h3 class="panel-title">3. Select SDK Call and Submit</h3>
            </div>
            <div class="panel-body submit-step">
                <div class="row">
                    <div class="col-md-6">
                        <div class="loading-icon loading-icon-initialstate"></div>

                    </div><!-- end col-md-6 -->

                    <div class="col-md-6">
                        <h4>Get the Data</h4>

                        <p><a class="btn btn-primary btn-lg" id="btnUpdateData" disabled style="width: 100%;" href="#"
                              role="button">Update Data</a></p>

                        <div class="loading-icon loading-icon-initialstate"></div>

                    </div>
                </div><!-- end row -->


            </div><!-- end panel-body -->
        </div><!-- end panel panel-info -->


        <div class="panel panel-success">
            <div class="panel-heading">
                <h3 class="panel-title">The Request</h3>

            </div>
            <div class="panel-body">
                <pre id="cenreq"></pre>


            </div>
        </div><!-- end panel panel-success -->


        <div class="panel panel-success">
            <div class="panel-heading">
                <h3 class="panel-title">The Returned Data</h3>
            </div>
            <div class="panel-body">
                <ul class="nav nav-tabs" role="tablist">

                    <li role="presentation" class="active"><a href="#dataSeriesData" aria-controls="dataSeriesData"
                                                              role="tab"
                                                              data-toggle="tab">Formatted Data</a></li>

                    <li role="presentation"><a href="#dataSeriesJson" aria-controls="dataSeriesJson" role="tab"
                                               data-toggle="tab">Raw Data</a></li>
                    <li role="presentation"><a href="#dataSeriesCode" aria-controls="dataSeriesCode" role="tab"
                                               data-toggle="tab">Code Example</a></li>
                </ul>
                <div class="loading-icon loading-icon-initialstate"></div>

                <!-- Tab panes -->
                <div class="tab-content">
                    <div role="tabpanel" class="tab-pane active" id="dataSeriesData">
                        <div id="dataSeriesResult">
                            <table class="table table-striped">
                                <thead>
                                <tr>

                                </tr>
                                </thead>
                                <tbody>

                                </tbody>
                            </table>
                        </div>

                    </div><!-- end dataSeriesData -->
                    <div role="tabpanel" class="tab-pane" id="dataSeriesJson">
                        <pre id="data" name="data"></pre>
                    </div><!-- end dataSeriesJson -->
                    <div role="tabpanel" class="tab-pane" id="dataSeriesCode"><pre>
    var <var>sdk</var> = new CitySDK();
    var <var>ckan</var> = sdk.modules.ckan;

    ckan.enable();

    // Set the server to pull data from
    ckan.<var>DEFAULT_ENDPOINTS.apiURL</var> = "http://www.civicdata.com/api/3/action/";

	var <var>request</var> = <var id="codeDemoRequestedSeriesID"></var>;

    ckan.APIRequest(<var>request</var>, function (<var>response</var>) {
            // Output raw JSON to raw data tab
            jQuery("#data").text(JSON.stringify(<var>response</var>));
                        // Output raw JSON to raw data tab
            jQuery("#data").text(JSON.stringify(<var>response</var>));

            // Output Formatted Data Table Tab
                        // Create Table Header
            jQuery("#dataSeriesResult thead tr").empty();
            var <var>headerFieldList</var> = [];
            jQuery.each(response.result.fields, function (<var>index</var>, <var>value</var>) {
                <var>headerFieldList</var>.push(<var>value.id</var>);
                jQuery("#dataSeriesResult thead tr").append("<th>" + <var>value.id</var> + "</th>");
            });

                        // Add Each Record
            jQuery("#dataSeriesResult tbody").empty();
            jQuery.each(response.result.records, function (<var>index</var>, <var>value</var>) {
                var <var>newFeature</var> = "<tr>";
                        jQuery.each(headerFieldList, function (<var>i</var>, <var>v</var>) {
                        if (<var>v</var> in <var>value</var>) {
                        <var>newFeature</var> += "
                        <td>" + <var>value[v]</var> + "</td>
                        ";
                        } else {
                        <var>newFeature</var> += "
                        <td></td>
                        ";
                        }
                        });
                        newFeature += "
                    </tr>";
                jQuery("#dataSeriesResult tbody").append(<var>newFeature</var>);
            });

    });

            </pre>
                    </div><!-- end dataSeriesCode -->
                </div>
            </div><!-- end panel-body -->
        </div><!-- end panel panel-info -->







    </div><!-- end col-md-12 -->
</div><!-- end row -->


<script>
    var sdk = new CitySDK();
    var ckan = sdk.modules.ckan;
    ckan.enable();
    ckan.DEFAULT_ENDPOINTS.apiURL = "//www.civicdata.com/api/3/action/";
    ckan.cacheLife = 8640000;


    var orgList = {};
    var packageList = {};
    var seriesMeta = {};

    jQuery(document).ready(function () {
        groupRequest = {
            "group": 'blds-building-permit-data'
        };

        jQuery(".city-and-dataset-step .hideWhileLoading").hide();
        jQuery(".city-and-dataset-step .loading-icon-initialstate").show();
        jQuery(".variables-and-filter-step .hideWhileLoading").hide();
        jQuery(".variables-and-filter-step .loading-icon-initialstate").show();

        ckan.seriesRequest(groupRequest, function (response) {
            var ichi = 0;

            jQuery.each(response.result.packages, function (index, value) {
                if (!(value.organization.id in orgList)) {
                    orgList[value.organization.id] = [];
                    jQuery("#cityDataOrg").append("<option value='" + value.organization.id + "'>" + value.organization.title + "</option>");
                    if (ichi == 0) {
                        ichi = value.organization.id;
                    }
                }
                orgList[value.organization.id].push(value.resources[0].id);
                packageList[value.resources[0].id] = value;
            });



            selectOrganization(ichi);
            jQuery(".city-and-dataset-step .hideWhileLoading").show();
            jQuery(".city-and-dataset-step .loading-icon-initialstate").hide();

        });

        jQuery('#cityDataOrg').change(function () {
            selectOrganization(jQuery(this).find("option:selected").val());
        });

        jQuery('#cityDataSet').change(function () {
            getSeriesFieldList(jQuery(this).find("option:selected").val(), function (response) {
                setSeriesFieldList(response);
            });
        });

        jQuery("#variables").change(buildRequest);
        jQuery("#fieldSort").change(buildRequest);
        jQuery("#btnUpdateData").on("click", function (e) {
            e.preventDefault();
            submitRequest();
        });

    });


    function selectOrganization(orgID) {

        if (orgID in orgList) {
            jQuery("#cityDataSet").empty();

            jQuery.each(orgList[orgID], function (index, value) {
                jQuery("#cityDataSet").append("<option value='" + value + "'>" + packageList[value]['title'] + "</option>");
            });


            getSeriesFieldList(jQuery("#cityDataSet").find("option:selected").val(), function (response) {
                setSeriesFieldList(response);
            });

        }
    } // end selectOrganization

    function getSeriesFieldList(seriesID, callback) {

        jQuery(".variables-and-filter-step .hideWhileLoading").hide();
        jQuery(".variables-and-filter-step .loading-icon-initialstate").show();

        jQuery(".serviceTextDescription").empty();
        var serviceTextDescription = "<h4 class='text-primary'>" + packageList[seriesID]['title'] + "</h4>\
            <p class='text-primary'><small>Last Updated:</small> " + packageList[seriesID]['revision_timestamp'] + "</p>\
            <p class='text-primary'>" + packageList[seriesID]['notes'] + "</p>";
        jQuery(".serviceTextDescription").append(serviceTextDescription);


        if (seriesID in seriesMeta) {
            buildRequest();
            callback(seriesMeta[seriesID]);
        } else {
            var request = {
                'resource_id': seriesID,
                'limit': 1
            };

            ckan.APIRequest(request, function (response) {
                seriesMeta[seriesID] = response.result.fields;
                buildRequest();
                callback(seriesMeta[seriesID]);
            });
        }
    }//getSeriesFieldList


    function setSeriesFieldList(response) {
        jQuery("#variables").empty();
        jQuery("#fieldSort").empty();
        jQuery("#fieldSort").append("<option value=\"\"></option>");

        jQuery.each(response, function (index, value) {
            jQuery("#variables").append("<option value=\"" + value.id + "\">" + value.id + "</option>");
            jQuery("#fieldSort").append("<option value=\"" + value.id + "\">" + value.id + "</option>");

        });
        jQuery(".variables-and-filter-step .hideWhileLoading").show();
        jQuery(".variables-and-filter-step .loading-icon-initialstate").hide();
        jQuery("#btnUpdateData").removeAttr("disabled");

    }// set setSeriesFieldList


    function buildRequest() {
        var request = {};

        request.from = jQuery("#cityDataSet").val();

        var selectedVariables = [];
        jQuery("#variables option:selected").each(function (n, o) {
            selectedVariables.push(o.value);
        });

        if (selectedVariables.length > 0) {
            request.variables = selectedVariables;
        }

        var sortBy = jQuery("#fieldSort").val();
        if (sortBy != "" && sortBy != null) {
            request.sort = sortBy;
        }

        jQuery("#cenreq").html(JSON.stringify(request, null, 4));
        jQuery("#codeDemoRequestedSeriesID").html(JSON.stringify(request, null, 4));

        return request;

    }


    function submitRequest() {
        var request = buildRequest();
        ckan.APIRequest(request, function (response) {

            // Output raw JSON to raw data tab
            jQuery("#data").text(JSON.stringify(response), null, 4);

            // Output Formatted Data Table Tab
            jQuery("#dataSeriesResult thead tr").empty();
            var headerFieldList = [];
            jQuery.each(response.result.fields, function (index, value) {
                headerFieldList.push(value.id);
                jQuery("#dataSeriesResult thead tr").append("<th>" + value.id + "</th>");
            });

            jQuery("#dataSeriesResult tbody").empty();
            jQuery.each(response.result.records, function (index, value) {
                var newFeature = "<tr>";
                jQuery.each(headerFieldList, function (i, v) {
                    if (v in value) {
                        newFeature += "<td>" + value[v] + "</td>";
                    } else {
                        newFeature += "<td></td>";
                    }
                });
                newFeature += "</tr>";
                jQuery("#dataSeriesResult tbody").append(newFeature);
            });

        });
    }

</script>
